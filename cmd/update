echo "UPDATING"
# Resets the porta poddy folder for github download
clean () {
    if [[ -d $PORTA_PODDY ]]; then
        rm -r $PORTA_PODDY
    fi
    mkdir -p $PORTA_PODDY
}

# Download system update
git clone https://github.com/ndrwmoss/going_poddy $PORTA_PODDY
echo "INSTALLING PODDY UPGRADES"

# Copy system commands
if [[ -d $PODDY/cmd ]]; then
    rm -r $PODDY/cmd
fi
cp -r $PORTA_PODDY/cmd $PODDY
chmod -R +x $PODDY/cmd

# Set the github download
address=${1:-https://github.com/ndrwmoss/going_poddy}

# shortcut for testing address
if [[ $1 == test ]]; then
    address=https://github.com/ndrwmoss/testing_poddy
fi

# If it's an external repository
repo_error () {
         echo "The repository should have 2 folders: workflows and installers."
         echo "The workflows folder shold contain all the .json workflows the package needs for installation."
         echo "The installers folder should contain installer files."
         echo "Go to https://github.com/ndrwmoss/testing_poddy to see an example of the repository format."
         exit 1
}

if [[ $address != https://github.com/ndrwmoss/going_poddy ]]; then
    clean
    git clone $address $PORTA_PODDY
    # Check workflows directory
    if [[ ! -d $PORTA_PODDY/workflows ]]; then
        echo "ERROR: the repository is invalid because it has no workflows directory."
        repo_error
    fi
    # Check installer directory
    if [[ ! -d $PORTA_PODDY/installers ]]; then
        echo "ERROR: the repository is invalid because it has no installers directory."
        repo_error
    fi
fi

echo "Moving workflows."
# copy and overwrite all workflows from the repo
\cp -r $PORTA_PODDY/workflows $PODDY

# check all files in the installers
for file in $PORTA_PODDY/installers/*.install; do
    # UPGRADE
    if [[ -f $PODDY/active/$file.install ]]; then
         echo "Upgrading $file"
        $PODDY/cmd/pkg_upgrade $file
    # MOVE
    else
        echo "Moving $file"
        \cp $PORTA_PODDY/installers/$file $PODDY/installers/$file
    fi
done

rm -r $PORTA_PODDY

exit 0