#!/bin/bash

# Read the file lines into a bash array
# The IFS= read -r line structure handles lines with spaces correctly
mapfile -t LINES < $PODDY/tmp/wiz_installed

# Format the array for the dialog --menu widget
# dialog --menu requires "tag" "description" pairs. 
# We use the line number as the "tag" and the line content as the "description".
MENU_ITEMS=()
for i in ${!LINES[@]}; do
    # Tags for dialog menu start from 1 (bash arrays from 0, so i+1)
    TAG=$((i + 1)) 
    DESCRIPTION="${LINES[$i]}"
    MENU_ITEMS+=($TAG $DESCRIPTION)
done

# Display the dialog menu and capture the selected TAG
exec 3>&1 # Redirect stdout to file descriptor 3
SELECTION=$(dialog --stdout \
    --title "Uninstall" \
    --menu "Choose a package to remove:" 20 50 15 \
    "${MENU_ITEMS[@]}")
exec 3>&- # Close file descriptor 3

# Check the return status (0 for OK, non-zero for Cancel/Esc)
if [ $? -eq 0 ]; then
    # Get the index (0-based) from the selected tag (1-based)
    INDEX=$((SELECTION - 1))
    SELECTED_LINE="${LINES[$INDEX]}"
    $PODDY/cmd/pkg_uninstall $SELECTED_LINE
fi

exit 0