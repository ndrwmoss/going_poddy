
#!/bin/bash
COMFY=${COMFY:-/workspace/ComfyUI}
COMFY_WORKFLOW=${COMFY_WORKFLOW:-$COMFY/user/default/workflows}
COMFY_NODES=${COMFY_NODES:-$COMFY/custom_nodes}
COMFY_MODELS=${$COMFY/models}
PODDY=${PODDY:-/gpoddy}
PODDY_ACTIVE=${PODDY_ACTIVE:-$PODDY/active}
PODDY_CMD=${PODDY_CMD:-$PODDY/cmd}
PODDY_WORKFLOWS=${PODDY_WORKFLOWS:-$PODDY/workflows}
PORTA_PODDY=${PORTA_PODDY:-$PODDY/porta_poddy}
GIT_ADDRESS=${GIT_ADDRESS:-"https://github.com/ndrwmoss/going_poddy"}
PREINSTALL=${PREINSTALL:-none}

#command = wizard | install | uninstall | update | preinstall | update_nodes | update_poddy
command=${1:-wizard}
shift
function update_poddy() {
    local restore_cwd=${PWD}
    local addy=${1:-"https://github.com/ndrwmoss/going_poddy"}
    echo "FLUSHING PODDY"
    if [[ -d ${PORTA_PODDY} ]]; then
        rm -r ${PORTA_PODDY}
    fi
    mkdir ${PORTA_PODDY}
    cd ${PORTA_PODDY}

    # DOWNLOAD
    echo "Hydrating Poddy"
    git clone ${1} .

    # COPY GOING_PODDY
    if [[ ${addy} == ${GIT_ADDRESS} ]]; then
        if [[ -d ${PODDY}/cmd ]]; then
            rm -R ${PODDY}/cmd
        fi
        mv -R ${PORTA_PODDY}/cmd/ ${PODDY}/cmd
    fi

    # COPY NEW WORKFLOWS TO WORKFLOW DIRECTORY
    for wf in ${PORTA_PODDY}/workflows/*.json; do
        if [[ -f $wf ]]; then
            cp -f ${PORTA_PODDY}/workflows/${wf}.json ${PODDY}/workflows/${wf}.json
            # COPY NEW WORKFLOWS TO COMFY IF ACTIVE
            if [[ -f ${COMFY_WORKFLOW}/${wf}.json ]]; then
                cp -f ${PODDY}/workflows/${wf}.json ${COMFY_WORKFLOW}/${wf}.json
            fi
        fi
    done

    # COPY DOWNLOADED INSTALLS TO INSTALL DIRECTORY
    for inst in ${PORTA_PODDY}/workflows/*.install; do
        if [[ -f "$inst" ]]; then
            cp -f ${PORTA_PODDY}/workflows/${inst}.install ${PODDY}/workflows/${inst}.install
        fi
    done
    echo "Poddy Refreshed!"

    # REMOVE DOWNLOADED FOLDER
    rm -r ${PORTA_PODDY}
    cd ${restore_cwd}
}
if [[ ${command} == "install" ]]; then
    for instruction in "$@"; do
        if [[ -f $PODDY_WORKFLOWS/$instruction.install ]]; then
            $PODDY_WORKFLOWS/$instruction.install install
        else
            echo "Workflow $instruction doesn't exist. No installation took place."
        fi
    done
else if [[ ${command} == "uninstall" ]]; then
    for instruction in "$@"; do
        if [[ -f $PODDY_WORKFLOWS/$instruction.install ]]; then
            $PODDY_WORKFLOWS/$instruction.install uninstall
        else
            echo "Workflow $instruction doesn't exist. No uninstallition can happen ."
        fi
    done
else if [[ ${command} == "preinstall" ]]; then
    for instruction in "${PREINSTALL}"; do
        if [[ -f $PODDY_WORKFLOWS/$instruction.install ]]; then
            $PODDY_WORKFLOWS/$instruction.install install
        else
            echo "Workflow $instruction doesn't exist. No installation took place."
        fi
    done
else if [[ ${command} == "update_poddy" ]]; then
    adr=${1:-$GIT_ADDRESS}
    update_poddy $adr
else if [[ ${command} == "update_nodes" ]]; then
    $PODDY_CMD/update_nodes.sh
else if [[ ${command} == "wizard" ]]; then
    $PODDY_CMD/wizard.sh
else
    if [[ -f $PODDY_CMD/$command.sh ]]; then
        $PODDY_CMD/$command.sh "$@"
    else
        echo "Flush it! This command is not valid!"
    fi
fi