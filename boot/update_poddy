
COMFY=${COMFY:-/workspace/ComfyUI}
COMFY_WORKFLOW=${COMFY_WORKFLOW:-$COMFY/user/default/workflows}
COMFY_NODES=${COMFY_NODES:-$COMFY/custom_nodes}
COMFY_MODELS=${COMFY/models}
PODDY=${PODDY:-/going_poddy}
PODDY_ACTIVE=${PODDY_ACTIVE:-$PODDY/active}
PODDY_CMD=${PODDY_CMD:-$PODDY/cmd}
PODDY_WORKFLOWS=${PODDY_WORKFLOWS:-$PODDY/workflows}
PORTA_PODDY=${PORTA_PODDY:-$PODDY/going_poddy}
PREINSTALL=${PREINSTALL:-"none"}
CIVITAI=${CIVITAI:-"none"}
restore_cwd=${PWD}

function update_poddy() {
    local restore_cwd=${PWD}

    echo "FLUSHING PODDY"
    if [[ -d $PORTA_PODDY ]]; then
        rm -r $PORTA_PODDY
    fi
    cd $PODDY
    # DOWNLOAD
    echo "Hydrating Poddy"
    git clone https://github.com/ndrwmoss/going_poddy

    if [[ -d ${PODDY}/cmd ]]; then
        rm -R ${PODDY}/cmd
    fi
    cp -r $PORTA_PODDY/cmd $PODDY/cmd

    if [[ -d ${PODDY}/installers ]]; then
        rm -R ${PODDY}/installers
    fi
    cp -r $PORTA_PODDY/installers $PODDY/installers

    if [[ -d ${PODDY}/workflows ]]; then
        rm -R ${PODDY}/workflows
    fi
    cp -r $PORTA_PODDY/workflows $PODDY/workflows
    
    if [[ -f /poddy ]]; then
        rm /poddy
    fi
    cp -r $PORTA_PODDY/poddy /poddy

    chmod +x $PODDY/poddy
    chmod -R +x $PODDY/cmd
    chmod -R +x $PODDY/installers

    # COPY NEW WORKFLOWS TO WORKFLOW DIRECTORY
    for wf in ${PODDY_WORKFLOWS}/*.json; do
        if [[ -f ${COMFY_WORKFLOW}/${wf}.json ]]; then
            rm ${COMFY_WORKFLOW}/${wf}.json
            cp -f ${PODDY_WORKFLOWS}/${wf}.json ${COMFY_WORKFLOW}/${wf}.json
        fi
    done
    echo "Poddy Refreshed!"

    # REMOVE DOWNLOADED FOLDER
    cd ${restore_cwd}
}
update_poddy