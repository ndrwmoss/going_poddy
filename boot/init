#!/bin/bash

echo "INIT: CUDA"
$PODDY/boot/cuda

rep=${REPO:-"none"}
$PODDY/boot/system

echo "INIT: COMFY"
$PODDY/boot/comfy

echo "INIT: POPULATING YOUR PODDY"
pip install --upgrade pip
pip install onnxruntime-gpu

echo "INIT: SAGE"
$PODDY/boot/sage

echo "INIT: SSH"
$PODDY/boot/ssh

echo "INIT: NGINX"
$PODDY/boot/nginx

echo "INIT: JUPYTER"
$PODDY/boot/jupyter

# Runs update.
if [[ $rep == "none" ]]; then
    echo "FETCHING WORKFLOWS"
    $PODDY/boot/update
elif [[ $rep == test ]]; then
    $PODDY/boot/update
    echo "FETCHING TEST PACKAGES"
    $PODDY/boot/update test
else
    echo "FETCHING WORKFLOWS"
    $PODDY/boot/update
    $PODDY/boot/update $rep
fi

# Runs installers if PREINSTALL is set to a non-empty string.
pre=${PREINSTALL:-"none"}
if [[ $pre != "none" ]]; then
    echo "INIT: installing $pre packages"
    /poddy i $pre
else
    echo "INIT: Going Poddy packages selected. To install packages open a terminal and type /poddy to open the Going Poddy wizard where you can select packages to install."
fi

$PODDY/cmd/update_nodes

echo "INIT COMPLETE: STARTING YOUR COMFY ON PORT 8188"
python $COMFY/main.py --use-sage-attention --listen --port=8188